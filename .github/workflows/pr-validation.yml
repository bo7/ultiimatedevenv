name: ğŸ›¡ï¸ PR Validation & Security

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  
  # Allow manual triggering for testing
  workflow_dispatch:

# Ensure only one workflow runs at a time per PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Basic validation and setup
  validate-pr:
    name: ğŸ“‹ Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    outputs:
      should-test: ${{ steps.changes.outputs.should-test }}
      
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ“Š Analyze changes
        id: changes
        run: |
          echo "should-test=true" >> $GITHUB_OUTPUT
          
          # Check for sensitive files
          if git diff --name-only origin/main...HEAD | grep -E '\.(env|key|pem|p12|pfx|keystore)$'; then
            echo "âŒ Sensitive files detected in PR"
            exit 1
          fi
          
          # Check PR title format
          if ! echo "${{ github.event.pull_request.title }}" | grep -qE '^(feat|fix|docs|chore|refactor|test|ci)(\(.+\))?: .+'; then
            echo "âš ï¸ PR title should follow conventional commit format"
            echo "Examples: 'feat: add new MCP server', 'fix: docker build issue'"
          fi
          
      - name: ğŸ§¹ Check for emojis in code
        run: |
          echo "ğŸ” Checking for emojis in modified files..."
          
          # Install emoji module
          pip3 install emoji
          
          # Get list of modified files
          MODIFIED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(py|md|js|ts|json|yaml|yml|sh|txt)$' || true)
          
          if [ -n "$MODIFIED_FILES" ]; then
            echo "ğŸ“ Checking files: $MODIFIED_FILES"
            
            # Run emoji check on modified files
            EMOJI_COUNT=0
            for file in $MODIFIED_FILES; do
              if [ -f "$file" ]; then
                FILE_EMOJIS=$(python3 -c "
import emoji
with open('$file', 'r', encoding='utf-8', errors='ignore') as f:
    content = f.read()
    emoji_count = len([c for c in content if emoji.is_emoji(c)])
    print(emoji_count)
                " 2>/dev/null || echo "0")
                
                if [ "$FILE_EMOJIS" -gt 0 ]; then
                  echo "âš ï¸ Found $FILE_EMOJIS emojis in $file"
                  EMOJI_COUNT=$((EMOJI_COUNT + FILE_EMOJIS))
                fi
              fi
            done
            
            if [ "$EMOJI_COUNT" -gt 0 ]; then
              echo "ğŸ§¹ Total emojis found: $EMOJI_COUNT"
              echo "ğŸ’¡ Run './clean-emojis.sh' to automatically remove emojis"
              echo "â„¹ï¸ Emojis will be automatically removed when merged"
            else
              echo "âœ… No emojis found in modified files"
            fi
          else
            echo "â„¹ï¸ No text files modified"
          fi

  # Job 2: Security scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate-pr
    if: needs.validate-pr.outputs.should-test == 'true'
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ›¡ï¸ Run security scan
        run: |
          echo "ğŸ” Scanning for security issues..."
          
          # Check for hardcoded secrets
          if git diff --name-only origin/main...HEAD | xargs grep -l -E "(password|secret|key|token|api_key)" 2>/dev/null; then
            echo "âš ï¸ Potential secrets found - please review"
          fi
          
          # Check for dangerous patterns
          if git diff --name-only origin/main...HEAD | xargs grep -l -E "(eval|exec|system|shell_exec)" 2>/dev/null; then
            echo "âš ï¸ Potentially dangerous code patterns found - please review"
          fi
          
          echo "âœ… Security scan completed"

  # Job 3: Docker build test
  docker-build:
    name: ğŸ³ Test Docker Build
    runs-on: ubuntu-latest
    needs: validate-pr
    if: needs.validate-pr.outputs.should-test == 'true'
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ³ Test Docker Build
        run: |
          echo "ğŸ—ï¸ Testing Docker build process..."
          
          # Test if docker-compose.yml is valid
          if [ -f "docker-compose.yml" ]; then
            echo "ğŸ“ Validating docker-compose.yml..."
            docker-compose config > /dev/null
            echo "âœ… docker-compose.yml is valid"
          fi
          
          # Test basic dockerfile syntax (if exists)
          if [ -f "Dockerfile" ]; then
            echo "ğŸ“ Validating Dockerfile..."
            docker build --dry-run -f Dockerfile . > /dev/null || echo "âš ï¸ Dockerfile may have issues"
          fi
          
          echo "âœ… Docker build test completed"

  # Job 4: Setup script test
  setup-test:
    name: ğŸš€ Test Setup Scripts
    runs-on: ubuntu-latest
    needs: validate-pr
    if: needs.validate-pr.outputs.should-test == 'true'
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ§ª Test setup scripts
        run: |
          echo "ğŸ§ª Testing setup scripts..."
          
          # Test if setup.sh exists and is executable
          if [ -f "setup.sh" ]; then
            if [ -x "setup.sh" ]; then
              echo "âœ… setup.sh is executable"
              
              # Test syntax
              bash -n setup.sh
              echo "âœ… setup.sh syntax is valid"
            else
              echo "âŒ setup.sh is not executable"
              exit 1
            fi
          fi
          
          # Test other shell scripts
          find . -name "*.sh" -type f | while read script; do
            if [ "$script" != "./setup.sh" ]; then
              echo "ğŸ§ª Testing $script syntax..."
              bash -n "$script"
            fi
          done
          
          echo "âœ… Setup script tests completed"

  # Job 5: Documentation check
  docs-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    needs: validate-pr
    if: needs.validate-pr.outputs.should-test == 'true'
    
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“ Check documentation
        run: |
          echo "ğŸ“ Checking documentation..."
          
          # Check if README.md exists
          if [ ! -f "README.md" ]; then
            echo "âŒ README.md is missing"
            exit 1
          fi
          
          # Check for broken links in markdown files
          find . -name "*.md" -type f | while read md_file; do
            echo "ğŸ” Checking links in $md_file"
            # Basic link syntax check
            if grep -q '](.*' "$md_file"; then
              echo "âœ… $md_file contains markdown links"
            fi
          done
          
          # Check if new features have documentation
          MODIFIED_SCRIPTS=$(git diff --name-only origin/main...HEAD | grep -E '\.(sh|py)$' || true)
          if [ -n "$MODIFIED_SCRIPTS" ]; then
            echo "ğŸ“‹ New scripts detected - ensure documentation is updated"
          fi
          
          echo "âœ… Documentation check completed"

  # Job 6: Final validation
  pr-ready:
    name: âœ… PR Ready for Review
    runs-on: ubuntu-latest
    needs: [validate-pr, security-scan, docker-build, setup-test, docs-check]
    if: always()
    
    steps:
      - name: ğŸ¯ Check all jobs status
        run: |
          echo "ğŸ“Š PR Validation Summary"
          echo "========================"
          
          if [ "${{ needs.validate-pr.result }}" != "success" ]; then
            echo "âŒ PR validation failed"
            exit 1
          fi
          
          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "âŒ Security scan failed"
            exit 1
          fi
          
          if [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "âŒ Docker build test failed"
            exit 1
          fi
          
          if [ "${{ needs.setup-test.result }}" != "success" ]; then
            echo "âŒ Setup script test failed"
            exit 1
          fi
          
          if [ "${{ needs.docs-check.result }}" != "success" ]; then
            echo "âŒ Documentation check failed"
            exit 1
          fi
          
          echo "âœ… All validation checks passed!"
          echo "ğŸ‰ PR is ready for maintainer review"
          
      - name: ğŸ“‹ Add success comment
        if: success()
        run: |
          echo "This PR has passed all automated checks:"
          echo "âœ… Security scan"
          echo "âœ… Docker build test"  
          echo "âœ… Setup script validation"
          echo "âœ… Documentation check"
          echo "âœ… Code quality check"
          echo ""
          echo "Ready for maintainer review! ğŸš€"
